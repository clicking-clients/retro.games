<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Word Defenders - Retro Games Collection</title>
<link rel="stylesheet" href="../../core/base.css">
<link rel="stylesheet" href="../../core/components.css">
<link rel="stylesheet" href="../../core/responsive.css">
<link rel="stylesheet" href="styles.css">
<style>
/* Word Defenders specific styles */
.word-defenders-container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.game-area {
    flex: 1;
    text-align: center;
}

.game-title {
    text-transform: uppercase;
    font-size: 2rem;
    color: #ffd700;
    text-shadow: 0 0 8px #f00;
    text-align: center;
    margin-bottom: 20px;
}

.game-canvas {
    border: 4px solid #0f0;
    height: 80vh;
    width: 100%;
    max-width: 960px;
    image-rendering: pixelated;
    background: black;
    display: block;
    margin: 0 auto;
}

.directional-controls {
    display: none;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
}

.dir-btn {
    width: 50px;
    height: 50px;
    font-size: 24px;
    background: #0f0;
    color: #000;
    border: 2px solid #fff;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
}

.dir-btn:hover {
    background: #0a0;
}

.mobile-input-area {
    display: none;
    margin: 20px 0;
}

.mobile-keypad {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin: 10px 0;
}

.keypad-row {
    display: flex;
    justify-content: center;
    gap: 5px;
}

.keypad-key {
    width: 40px;
    height: 40px;
    font-size: 16px;
    background: #0f0;
    color: #000;
    border: 2px solid #fff;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
}

.keypad-key:hover {
    background: #0a0;
}

.input-help {
    color: #0f0;
    font-size: 14px;
    margin-top: 10px;
}

.sidebar {
    width: 300px;
    color: #0f0;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.section-title {
    color: #ffd700;
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 16px;
}

.scoreboard {
    border: 2px solid #0f0;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
}

.controls {
    border: 2px solid #0f0;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
}

.control-sliders {
    display: flex;
    gap: 15px;
    margin: 15px 0;
}

.slider-group {
    flex: 1;
}

.slider-group label {
    display: block;
    margin-bottom: 5px;
    color: #0f0;
    font-size: 14px;
}

.slider-group input[type="range"] {
    width: 100%;
    margin-bottom: 5px;
}

.slider-value {
    color: #0f0;
    font-size: 14px;
    text-align: center;
}

.word-list-settings {
    border: 2px solid #0f0;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
}

.word-list-select {
    width: 100%;
    padding: 8px;
    background: #1a1a2e;
    color: #0f0;
    border: 2px solid #0f0;
    border-radius: 5px;
    margin-bottom: 10px;
}

.current-word-list {
    margin-top: 15px;
}

.word-list-display {
    background: rgba(0, 0, 0, 0.5);
    padding: 10px;
    border-radius: 5px;
    font-size: 12px;
    max-height: 100px;
    overflow-y: auto;
}

.quotes {
    border: 2px solid #0f0;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    text-align: center;
    font-style: italic;
    color: #0f0;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .word-defenders-container {
        flex-direction: column;
        padding: 10px;
    }
    
    .game-canvas {
        max-width: 100vw;
        height: 60vh;
    }
    
    .directional-controls {
        display: flex;
    }
    
    .mobile-input-area {
        display: block;
    }
    
    .sidebar {
        width: 100%;
        order: 3;
    }
    
    .game-area {
        order: 2;
    }
    
    .directional-controls {
        order: 4;
    }
    
    .mobile-input-area {
        order: 5;
    }
}
</style>
</head>
<body>
<!-- Enhanced Navigation will be automatically inserted here -->
<div class="word-defenders-container">
    <div class="game-area">
        <h1 class="game-title">Word Defenders</h1>

        
        <!-- Directional Controls (Mobile) -->
        <div class="directional-controls">
            <button class="dir-btn" id="dirUpBtn" aria-label="Move Up">↑</button>
            <div class="keypad-row">
                <button class="dir-btn" id="dirLeftBtn" aria-label="Move Left">←</button>
                <button class="dir-btn" id="dirRightBtn" aria-label="Move Right">→</button>
            </div>
        </div>
        
        <!-- Mobile Input Area -->
        <div class="mobile-input-area">
            <div class="section-title">TYPE WORDS</div>
            <div class="mobile-keypad">
                <div class="keypad-row">
                    <button class="keypad-key" data-key="q">Q</button>
                    <button class="keypad-key" data-key="w">W</button>
                    <button class="keypad-key" data-key="e">E</button>
                    <button class="keypad-key" data-key="r">R</button>
                    <button class="keypad-key" data-key="t">T</button>
                    <button class="keypad-key" data-key="y">Y</button>
                    <button class="keypad-key" data-key="u">U</button>
                    <button class="keypad-key" data-key="i">I</button>
                    <button class="keypad-key" data-key="o">O</button>
                    <button class="keypad-key" data-key="p">P</button>
                </div>
                <div class="keypad-row">
                    <button class="keypad-key" data-key="a">A</button>
                    <button class="keypad-key" data-key="s">S</button>
                    <button class="keypad-key" data-key="d">D</button>
                    <button class="keypad-key" data-key="f">F</button>
                    <button class="keypad-key" data-key="g">G</button>
                    <button class="keypad-key" data-key="h">H</button>
                    <button class="keypad-key" data-key="j">J</button>
                    <button class="keypad-key" data-key="k">K</button>
                    <button class="keypad-key" data-key="l">L</button>
                </div>
                <div class="keypad-row">
                    <button class="keypad-key" data-key="z">Z</button>
                    <button class="keypad-key" data-key="x">X</button>
                    <button class="keypad-key" data-key="c">C</button>
                    <button class="keypad-key" data-key="v">V</button>
                    <button class="keypad-key" data-key="b">B</button>
                    <button class="keypad-key" data-key="n">N</button>
                    <button class="keypad-key" data-key="m">M</button>
                    <button class="keypad-key" data-key="backspace">⌫</button>
                </div>
            </div>
            <div class="input-help">Tap letters to type words in your lane</div>
        </div>
    </div>
    
    <div class="sidebar">
        <div class="scoreboard" role="region" aria-label="Game Score">
            <div class="section-title">SCORE</div>
            <div>Score: <span id="score" aria-live="polite">0</span> | Words Left: <span id="wordsLeft" aria-live="polite">0</span> | WPM: <span id="wpm" aria-live="polite">0</span></div>
            <div>Timer: <span id="timerDisplay" aria-live="polite">0:00</span></div>
        </div>
        
        <div class="controls" role="region" aria-label="Game Controls">
            <div class="section-title">CONTROLS</div>
            <div role="list">
                <div role="listitem">1 / ←: Move Left</div>
                <div role="listitem">2 / →: Move Right</div>
                <div role="listitem">Type letters: Shoot word in lane</div>
                <div role="listitem">Space: Start / Pause</div>
                <div role="listitem">0: Reset</div>
            </div>
        </div>
        
        <div class="control-sliders">
            <div class="slider-group">
                <label for="speedSlider">SPEED</label>
                <input type="range" id="speedSlider" min="1" max="10" step="1" value="2" aria-describedby="speedVal">
                <div id="speedVal" class="slider-value" aria-live="polite">2</div>
            </div>
            <div class="slider-group">
                <label for="laneSlider">LANES</label>
                <input type="range" id="laneSlider" min="1" max="8" step="1" value="4" aria-describedby="laneVal">
                <div id="laneVal" class="slider-value" aria-live="polite">4</div>
            </div>
        </div>
        
        <div class="word-list-settings" role="region" aria-label="Word List Settings">
            <div class="section-title">WORD LIST</div>
            <label for="wordListSelect">Difficulty Level:</label>
            <select id="wordListSelect" aria-describedby="wordList"></select>
            
            <div class="current-word-list">
                <div class="section-title">CURRENT WORDS</div>
                <div id="currentWordList" class="word-list-display" aria-live="polite"></div>
            </div>
        </div>
        
        <div class="quotes">
            <div id="quotes" aria-live="polite">You are brave and strong!</div>
        </div>
    </div>
</div>

<script type="module">
import { EnhancedNavigation } from '../../core/navigation.js';
import { GameContainer } from '../../components/GameContainer.js';
import { GAME_CONFIGS } from '../../config/games.js';

// Initialize enhanced navigation
const navigation = new EnhancedNavigation();

// Initialize game container with word-defenders config
const gameConfig = GAME_CONFIGS['word-defenders'];
const gameContainer = new GameContainer(gameConfig);

// Initialize the container
gameContainer.init();

// Use the GameContainer's canvas system properly
const canvas = gameContainer.getCanvas();
const ctx = canvas.getContext('2d');

// Game constants
let W = canvas.width, H = canvas.height;
let lanes = 4, playerLane = 0; // Start in leftmost lane
let laneW = W/lanes, floorY = H-48;

// Game variables
let score = 0, lives = 3, running = true, gameOver = false;
let speedValue = 2/4; // Default speed
let words = [], wordsLeft = 0, totalWordsInLevel = 20, spawnedCount = 0;
let rocketLaunched = false, lastOutcomeSuccess = false;
let startTime, timerDuration = 180;
let level = 1;

// Word lists data
const wordListsData = [
    {name:"Beginner 0 (2 letter)", words:["an", "as", "at", "in", "is", "it" ]},
    {name:"Beginner 1 (3 letter)", words:["ant", "nan", "nap", "nip", "nit", "pan", "pat", "pin", "pip", "pit", "sat", "sip", "sit", "tan", "tap", "tin", "tip" ]},
    {name:"Easy 2", words:["fish","frog","tree","milk","bird"]},
    {name:"Medium 3", words:["apple","chair","train","horse","glass"]},
    {name:"Hard 4", words:["banana","school","friend","planet","happy"]},
    {name:"Expert 5", words:["elephant","computer","kangaroo","mountain","diamond"]}
];

let wordBank = [...wordListsData[0].words];

// Quotes for encouragement
const QUOTES = ["You are brave and strong!","Trust yourself—you can do it!","Your kindness makes magic!","Every step shows courage!","You are unstoppable!","Believe in yourself!","Your heart is full of power!","You are wise and brave!","Shine with your own light!","You make the world brighter!"];
let quoteIndex = 0;

// Random spawn timing
let nextSpawnAt = 0;

// Utility functions
function laneX(l) { return l*laneW+laneW/2; }
function randWord() { return wordBank[Math.floor(Math.random()*wordBank.length)]; }
function randColor() { 
    const colors = ["#0f0","#0ff","#ff0","#f0f","#f60","#0fa","#ff3","#f3f","#3ff","#f06","#f33","#33f","#fff"];
    return colors[Math.floor(Math.random()*colors.length)];
}

function scheduleNextSpawn() {
    nextSpawnAt = Date.now() + 350 + Math.random()*1100;
}

function spawnWord() {
    if(wordsLeft <= 0 || spawnedCount >= totalWordsInLevel) return;
    if(Date.now() < nextSpawnAt) return;
    
    const l = Math.floor(Math.random()*lanes);
    const crowded = words.some(w => w.lane === l && w.y < 80 && !w.fly);
    
    if(!crowded) {
        const text = randWord();
        words.push({
            text, lane: l, y: -10, progress: 0, done: false, 
            speed: speedValue, color: randColor(), fly: false, alpha: 1
        });
        spawnedCount++;
    }
    scheduleNextSpawn();
}

function drawWord(w) {
    if(w.done) return;
    
    ctx.save();
    ctx.globalAlpha = w.alpha;
    
    // Draw word background
    ctx.fillStyle = w.color;
    ctx.fillRect(laneX(w.lane) - 40, w.y - 8, 80, 20);
    
    // Draw word text
    ctx.fillStyle = "#000";
    ctx.font = '16px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(w.text, laneX(w.lane), w.y + 6);
    
    // Draw progress indicator
    if(w.progress > 0) {
        ctx.fillStyle = "#fff";
        ctx.fillRect(laneX(w.lane) - 40, w.y - 8, (w.progress / w.text.length) * 80, 20);
        ctx.fillStyle = "#000";
        ctx.fillText(w.text.substring(0, w.progress), laneX(w.lane), w.y + 6);
    }
    
    ctx.restore();
}

function draw() {
    // Clear canvas
    ctx.fillStyle = "#000"; 
    ctx.fillRect(0, 0, W, H);
    
    // Draw lane dividers
    ctx.strokeStyle = "#0f0"; 
    ctx.lineWidth = 1;
    for(let l = 1; l < lanes; l++) {
        ctx.beginPath(); 
        ctx.moveTo(l*laneW+0.5, 0); 
        ctx.lineTo(l*laneW+0.5, H); 
        ctx.stroke();
    }
    
    // Draw floor
    ctx.beginPath(); 
    ctx.moveTo(0, floorY+12); 
    ctx.lineTo(W, floorY+12); 
    ctx.stroke();
    
    // Draw words
    for(const w of words) drawWord(w);
    
    // Draw UI
    ctx.fillStyle = "#0f0"; 
    ctx.font = '16px monospace'; 
    ctx.textAlign = 'left'; 
    ctx.fillText(`LIVES: ${lives}`, 8, 16);
    
    // Draw player
    ctx.textAlign = 'center';
    ctx.fillStyle = "#ff0"; 
    ctx.fillRect(laneX(playerLane)-15, floorY-12, 30, 12);
    
    // Draw status
    ctx.fillStyle = "#0f0"; 
    ctx.textAlign = 'right'; 
    ctx.fillText(running ? 'RUN' : 'PAUSE', W-8, 16);
}

function step() {
    if(!running) { 
        draw(); 
        requestAnimationFrame(step); 
        return; 
    }
    
    spawnWord();
    
    // Move words down
    for(const w of words) { 
        if(!w.done && !w.fly) w.y += speedValue; 
    }
    
    // Check for missed words
    for(const w of words) {
        if(!w.done && !w.fly && w.y >= floorY) {
            lives--; 
            w.done = true; 
            wordsLeft = Math.max(0, wordsLeft-1);
            
            if(lives <= 0) {
                gameOver = true; 
                running = false; 
                lastOutcomeSuccess = false;
            }
        }
    }
    
    // Check level completion
    if(!gameOver && wordsLeft === 0) {
        running = false;
        lastOutcomeSuccess = (lives > 0);
        if(lastOutcomeSuccess) {
            // Level complete!
            level++;
            gameContainer.updateLives(level);
        }
    }
    
    // Update score
    gameContainer.updateScore(score);
    
    draw();
    requestAnimationFrame(step);
}

function wordInPlayerLane() {
    const candidates = words.filter(w => !w.done && !w.fly && w.lane === playerLane);
    candidates.sort((a,b) => b.y - a.y);
    return candidates[0] || null;
}

function resetLevel() {
    words = [];
    wordsLeft = totalWordsInLevel;
    spawnedCount = 0;
    running = true;
    gameOver = false;
    rocketLaunched = false;
    startTime = Date.now();
    scheduleNextSpawn();
}

// Initialize UI elements
function initUI() {
    // Populate word list selector
    const wordListSelect = document.getElementById('wordListSelect');
    wordListsData.forEach((wl, i) => {
        let opt = document.createElement('option');
        opt.value = i; 
        opt.textContent = wl.name;
        wordListSelect.appendChild(opt);
    });
    
    // Set up sliders
    const speedSlider = document.getElementById('speedSlider');
    const laneSlider = document.getElementById('laneSlider');
    const speedVal = document.getElementById('speedVal');
    const laneVal = document.getElementById('laneVal');
    
    speedSlider.oninput = () => {
        speedValue = parseInt(speedSlider.value) / 4;
        speedVal.textContent = speedSlider.value;
    };
    
    laneSlider.oninput = () => {
        lanes = parseInt(laneSlider.value);
        laneW = W / lanes;
        laneVal.textContent = laneSlider.value;
    };
    
    // Set up word list change
    wordListSelect.onchange = () => {
        wordBank = [...wordListsData[parseInt(wordListSelect.value)].words];
        resetLevel();
        updateWordListDisplay();
    };
    
    // Set up mobile controls
    setupMobileControls();
    
    // Update initial displays
    updateWordListDisplay();
    updateQuotes();
}

function setupMobileControls() {
    // Directional buttons
    document.getElementById('dirUpBtn').onclick = () => {
        if(playerLane > 0) playerLane--;
    };
    
    document.getElementById('dirLeftBtn').onclick = () => {
        if(playerLane > 0) playerLane--;
    };
    
    document.getElementById('dirRightBtn').onclick = () => {
        if(playerLane < lanes - 1) playerLane++;
    };
    
    // Keypad buttons
    document.querySelectorAll('.keypad-key').forEach(btn => {
        btn.onclick = () => {
            const key = btn.dataset.key;
            if(key === 'backspace') {
                // Handle backspace
                return;
            }
            
            // Handle letter input
            const target = wordInPlayerLane();
            if(!target) return;
            
            const expected = target.text[target.progress] || '';
            if(key.toLowerCase() === expected) {
                target.progress++;
                if(target.progress >= target.text.length) {
                    target.fly = true; 
                    target.done = true; 
                    wordsLeft = Math.max(0, wordsLeft-1);
                    score += target.text.length;
                }
            }
        };
    });
}

function updateWordListDisplay() {
    const currentWordList = document.getElementById('currentWordList');
    currentWordList.textContent = wordBank.slice(0, 10).join(', ') + (wordBank.length > 10 ? '...' : '');
}

function updateQuotes() {
    const quotesEl = document.getElementById('quotes');
    quotesEl.textContent = QUOTES[quoteIndex];
    quoteIndex = (quoteIndex + 1) % QUOTES.length;
}

function updateScoreDisplay() {
    document.getElementById('score').textContent = score;
    document.getElementById('wordsLeft').textContent = wordsLeft;
    document.getElementById('wpm').textContent = Math.round(score / 5); // Simple WPM calculation
}

// Event listeners
gameContainer.on('keydown', (e) => {
    if(e.key === '1' || e.key === 'ArrowLeft') {
        playerLane = Math.max(0, playerLane-1);
        return;
    }
    if(e.key === '2' || e.key === 'ArrowRight') {
        playerLane = Math.min(lanes-1, playerLane+1);
        return;
    }
    if(e.code === 'Space') {
        running = !running;
        return;
    }
    if(e.key === '0') {
        resetLevel();
        return;
    }
    
    // Handle letter input
    if(e.key.length === 1 && /[a-z]/i.test(e.key)) {
        const target = wordInPlayerLane();
        if(!target) return;
        
        const expected = target.text[target.progress] || '';
        if(e.key.toLowerCase() === expected) {
            target.progress++;
            if(target.progress >= target.text.length) {
                target.fly = true; 
                target.done = true; 
                wordsLeft = Math.max(0, wordsLeft-1);
                score += target.text.length;
                updateScoreDisplay();
            }
        }
    }
});

// Touch controls for mobile
let touchStartX = 0;
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    touchStartX = touch.clientX - rect.left;
});

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    const touch = e.changedTouches[0];
    const rect = canvas.getBoundingClientRect();
    const touchX = touch.clientX - rect.left;
    
    // Move player based on touch position
    const touchLane = Math.floor((touchX / W) * lanes);
    playerLane = Math.max(0, Math.min(lanes-1, touchLane));
});

// Initialize game
initUI();
resetLevel();
step();

// Update game container with game instance
gameContainer.gameInstance = {
    pause: () => { running = false; },
    resume: () => { running = true; },
    restart: resetLevel
};

console.log('REAL Word Defenders game initialized with universal system - Full UI restored');
</script>
</body>
</html>
