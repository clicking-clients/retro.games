<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Number Defenders</title>
<style>
:root { --green:#0f0; --yellow:#ff0; --red:#f00; --bg:#000; }
html, body { height:100%; margin:0; padding:0; background: var(--bg); font-family: monospace; color: var(--green); overflow:hidden; }
#container { display:flex; justify-content:center; align-items:flex-start; gap:20px; padding:20px; position:relative; }
#gameNav, 
#gameNav a {
  display: block;
  margin-top: 5px;
  text-transform: uppercase;
  color: #0f0;
  text-decoration: none;
}

#gameNav a.active {
  color: #ff0;       /* highlight color */
  font-weight: bold;  /* optional emphasis */
  text-decoration: underline;
}
#game { border:4px solid var(--green); width:540px; height:640px; background: var(--bg); image-rendering: pixelated; display:block; position:relative; z-index:1; }
#sidebar { width:450px; display:flex; flex-direction:column; gap:10px; }
#title { text-transform: uppercase; font-size: 2rem; color: #ff0; text-shadow: 0 0 8px #f00; text-align: center; }
#scoreboard { border:2px solid var(--green); padding:8px; font-size:0.9rem; }
.section-title { color: var(--yellow); font-weight:bold; margin-bottom:4px; }
#controls { font-size:0.9rem; }
.pill { border:1px solid var(--green); padding:6px 8px; display:inline-block; cursor:pointer; margin-right:4px; user-select:none; }
.toggle input { accent-color: var(--green); }
#wordList { width:100%; height:80px; background:#001100; color: var(--green); border:1px solid var(--green); padding:6px; font-family:monospace; }
input[type=range] { width:100%; }
#quotes { margin-top:8px; font-size:0.9rem; height:24px; text-align:center; }
#rocketOverlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
#splashScreen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); color:#fff; font-size:2rem; display:none; justify-content:center; align-items:center; flex-direction:column; text-align:center; z-index:1000; }
#splashScreen button { margin-top:20px; padding:10px 20px; font-size:1rem; cursor:pointer; }
.level-settings { margin-top:8px; font-size:0.9rem; }
.mode-settings { margin-top:8px; font-size:0.9rem; }
</style>
</head>
<body>

<div id="splashScreen"><div id="splashText">Level Complete!</div><button id="splashBtn">Next Level</button></div>
<div id="container">  
   <nav id="gameNav" style="padding:10px; background:#111; color:#0f0; font-family:monospace;">
    <strong>Games:</strong>
  </nav>
  <script src="navigation.js"></script>
  <canvas id="game" width="540" height="640"></canvas>
  <div id="sidebar">
    <div id="title">NUMBER DEFENDERS</div>
    <div id="scoreboard">
      <div class="section-title">SCORE</div>
      <div>Score: <span id="score">0</span> | Problems Left: <span id="wordsLeft">0</span></div>
      <div>Timer: <span id="timerDisplay">0:00</span></div>
    </div>
    <div id="controls">
      <div class="section-title">CONTROLS</div>
      ←: Move Left<br>
      →: Move Right<br>
      Type numbers: Solve problem in lane<br>
      Space: Start / Pause<br>
      R: Reset Level
    </div>

    <div style="display:flex; gap:10px;">
      <div>
        <div class="section-title">SPEED</div>
        <input type="range" id="speedSlider" min="1" max="10" step="1" value="2">
        <div id="speedVal">2</div>
      </div>
      <div>
        <div class="section-title">LANES</div>
        <input type="range" id="laneSlider" min="1" max="8" step="1" value="4">
        <div id="laneVal">4</div>
      </div>
      <div>
        <div class="section-title">TIMER</div>
        <input type="range" id="timerSlider" min="1" max="10" step="1" value="3">
        <div id="timerVal">3</div>
        <label><input type="checkbox" id="timerToggle"> Enable Timer</label>
      </div>
    </div>

    <div class="level-settings">
      <div class="section-title">LEVEL</div>
      <label><input type="radio" name="level" value="beginner" checked> Beginner (1-10)</label><br>
      <label><input type="radio" name="level" value="medium"> Medium (1-20)</label><br>
      <label><input type="radio" name="level" value="great"> Great (1-50)</label><br>
      <label><input type="radio" name="level" value="expert"> Expert (1-100)</label>
    </div>

    <div class="mode-settings">
      <div class="section-title">MODE</div>
      <label><input type="radio" name="mode" value="both" checked> + / - </label>
      <label><input type="radio" name="mode" value="+"> Addition </label>
      <label><input type="radio" name="mode" value="-"> Subtraction </label><br>
      <label><input type="checkbox" id="allowNeg"> Allow negative answers</label>
    </div>

    <div id="quotes"></div>
  </div>
  <canvas id="rocketOverlay" width="1200" height="720"></canvas>
</div>
<script type="module">
import { Rocket } from '../../rocket.js';
import { Fireworks } from '../../fireworks.js';
import { GameAudio } from '../../audio.js';
(() => {
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;
let lanes = 4, playerLane = 0; // Start in leftmost lane
let laneW = W/lanes, floorY = H-48;

let score=0, lives=3, running=true, gameOver=false;
let speedValue=parseFloat(document.getElementById('speedSlider').value)/4;
let words=[], wordsLeft=0, totalWordsInLevel=20, spawnedCount=0;
let rocketLaunched=false, lastOutcomeSuccess=false;
let startTime, timerDuration=180;
let level=1, maxOperand=20;

const speedSlider=document.getElementById('speedSlider');
const laneSlider=document.getElementById('laneSlider');
const speedVal=document.getElementById('speedVal');
const laneVal=document.getElementById('laneVal');
const scoreEl=document.getElementById('score');
const wordsLeftEl=document.getElementById('wordsLeft');
const timerToggle=document.getElementById('timerToggle');
const timerSlider=document.getElementById('timerSlider');
const timerVal=document.getElementById('timerVal');
const timerDisplay=document.getElementById('timerDisplay');
const quotesEl=document.getElementById('quotes');
const splashScreen=document.getElementById('splashScreen');
const splashBtn=document.getElementById('splashBtn');
const splashText=document.getElementById('splashText');

const rocketOverlay=document.getElementById('rocketOverlay');
const rocketCtx=rocketOverlay.getContext('2d');

// Initialize modular components
let audio, fireworks, rocket;

async function initModularComponents() {
  try {
    audio = new GameAudio();
    fireworks = new Fireworks(rocketOverlay, audio);
    
    // Create rocket instance
    rocket = new Rocket(
      rocketOverlay,
      { 
        fireworksPop: () => audio.fireworksPop(), 
        rocketRumble: () => audio.rocketRumble(), 
        actx: audio.actx 
      },
      () => { splashLevelOver(true); level++; }
    );
    
    console.log('Modular components initialized successfully');
  } catch (error) {
    console.error('Failed to initialize modular components:', error);
  }
}

// Audio wrapper functions for compatibility
function beep(freq=440, dur=0.07, type='square', vol=0.02) {
  if (audio) audio.beep(freq, dur, type, vol);
}
function rocketRumble() {
  if (audio) audio.rocketRumble();
}
function fireworksPop() {
  if (audio) audio.fireworksPop();
}

/* ===== quotes ===== */
const QUOTES=["You are brave and strong!","Trust yourself—you can do it!","Every step shows courage!","You are unstoppable!"];
let quoteIndex=0;
function rotateQuotes(){ quotesEl.textContent=QUOTES[quoteIndex]; quoteIndex=(quoteIndex+1)%QUOTES.length; }
setInterval(rotateQuotes,5000); rotateQuotes();

/* ===== words & lanes ===== */
function laneX(l){ return l*laneW+laneW/2; }
function randColor(){ const colors=["#0f0","#0ff","#ff0","#f0f","#f60","#0fa","#ff3","#f3f","#3ff","#f06","#f33","#33f","#fff"];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* ===== Math problem generator ===== */
function generateMathProblem(){
  // Get selected level and determine max operand
  const levelSelection = document.querySelector('input[name="level"]:checked').value;
  let maxOperand;
  switch(levelSelection) {
    case 'beginner': maxOperand = 10; break;
    case 'medium': maxOperand = 20; break;
    case 'great': maxOperand = 50; break;
    case 'expert': maxOperand = 100; break;
    default: maxOperand = 20;
  }
  
  let a = Math.floor(Math.random()*maxOperand) + 1; // +1 to avoid 0
  let b = Math.floor(Math.random()*maxOperand) + 1; // +1 to avoid 0
  let op = document.querySelector('input[name="mode"]:checked').value;
  if(op==='both'){ op = Math.random()<0.5 ? '+' : '-'; }
  if(!document.getElementById('allowNeg').checked && op==='-' && b>a){
    [a,b]=[b,a];
  }
  const text = `${a}${op}${b}`;
  const answer = op==='+' ? a+b : a-b;
  return { text, answer };
}

/* Random spawn timing */
let nextSpawnAt=0;
function scheduleNextSpawn(){ nextSpawnAt = Date.now() + 350 + Math.random()*1100; }
function spawnWord(){
  if(wordsLeft<=0 || spawnedCount>=totalWordsInLevel) return;
  if(Date.now() < nextSpawnAt) return;
  const l = Math.floor(Math.random()*lanes);
  const crowded=words.some(w=>w.lane===l && w.y<80 && !w.fly);
  if(!crowded){
    const problem = generateMathProblem();
    words.push({ text: problem.text, answer: problem.answer, lane:l, y:-10, progress:0, input:'', done:false, fly:false, alpha:1, color: randColor() });
    spawnedCount++;
  }
  scheduleNextSpawn();
}

// Rocket class is now imported from modular components

/* ===== Level Reset ===== */
function resetLevel(keepLevelNumber=false){
  if(!keepLevelNumber) level=1;
  score=0; lives=3; running=true; gameOver=false; words=[]; rocketLaunched=false; lastOutcomeSuccess=false;
  lanes=parseInt(laneSlider.value); laneW=W/lanes;
  speedValue=parseFloat(speedSlider.value)/4;
  totalWordsInLevel = 20;
  spawnedCount=0;
  wordsLeft=totalWordsInLevel;
  startTime = Date.now();
  timerDuration=parseInt(timerSlider.value)*60*1000;
  maxOperand = level<=2 ? 10 : 20;
  updateScore();
  scheduleNextSpawn();
  draw();
  if(!rocket){
    // Rocket is now initialized in initModularComponents
    console.log('Rocket not initialized yet');
  } else { rocket.resetForLevel(); }
}
function startNextLevel(){ resetLevel(true); }

/* ===== scoreboard ===== */
function updateScore(){ scoreEl.textContent=score; wordsLeftEl.textContent=wordsLeft; }

/* ===== draw ===== */
function drawWord(w){
  const x=laneX(w.lane), y=w.y;
  ctx.font='28px monospace'; ctx.textAlign='center';
  ctx.fillStyle=w.color;
  let displayText = w.text + (w.input ? ` (${w.input})` : '');
  if(w.fly){ w.y-=6; w.alpha-=0.07; ctx.fillStyle=`rgba(255,255,255,${w.alpha})`; ctx.fillText(displayText,x,y); if(w.alpha<=0) w.done=true; return; }
  if(w.done && !w.fly){ ctx.fillStyle="#f00"; ctx.save(); ctx.translate(x,y); ctx.rotate(Math.PI); ctx.fillText(displayText,0,0); ctx.restore(); return; }
  ctx.fillText(displayText,x,y);
}
function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#0f0"; ctx.lineWidth=1;
  for(let l=1;l<lanes;l++){ ctx.beginPath(); ctx.moveTo(l*laneW+0.5,0); ctx.lineTo(l*laneW+0.5,H); ctx.stroke(); }
  ctx.beginPath(); ctx.moveTo(0,floorY+12); ctx.lineTo(W,floorY+12); ctx.stroke();
  for(const w of words) drawWord(w);
  ctx.fillStyle="#0f0"; ctx.font='16px monospace'; ctx.textAlign='left'; ctx.fillText(`LIVES: ${lives}`,8,16);
  ctx.textAlign='center'; ctx.fillStyle='#ff0'; ctx.fillRect(laneX(playerLane)-15,floorY-12,30,12);
  ctx.fillStyle='#0f0'; ctx.textAlign='right'; ctx.fillText(running?'RUN':'PAUSE',W-8,16);
}

/* ===== game step ===== */
function step(){
  if(!running){ draw(); requestAnimationFrame(step); return; }
  if(timerToggle && timerToggle.checked){
    const elapsed=Date.now()-startTime, remaining=Math.max(0,timerDuration-elapsed);
    timerDisplay.textContent=Math.floor(remaining/60000)+":"+("0"+Math.floor((remaining%60000)/1000)).slice(-2);
    if(remaining<=0){ gameOver=true; running=false; lastOutcomeSuccess=false; splashLevelOver(false); return; }
  }
  spawnWord();
  for(const w of words) if(!w.done && !w.fly) w.y+=speedValue;

  for(const w of words){
    if(!w.done && !w.fly && w.y>=floorY){ lives--; w.done=true; wordsLeft = Math.max(0, wordsLeft-1); updateScore(); beep(140,0.08); if(lives<=0){ gameOver=true; running=false; lastOutcomeSuccess=false; splashLevelOver(false); } }
  }

  draw();
  requestAnimationFrame(step);
}

/* ===== keyboard input ===== */
document.addEventListener('keydown',(e)=>{
  if(e.key===' '){ running=!running; return; }
  if(e.key.toLowerCase()==='r'){ resetLevel(true); return; }

  if(e.key==='ArrowLeft'){ playerLane=Math.max(0,playerLane-1); return; }
  if(e.key==='ArrowRight'){ playerLane=Math.min(lanes-1,playerLane+1); return; }

  const target = words.find(w=>!w.done && w.lane===playerLane);
  if(!target) return;
  
  // Handle digit input
  if(/[0-9\-]/.test(e.key)){
    if(e.key==='-' && target.input.includes('-')) return;
    target.input = (target.input||'') + e.key;
    
    // Check if the input is complete and correct
    const inputNum = parseInt(target.input);
    if(inputNum === target.answer){
      // Correct answer!
      beep(800, 0.2, 'sine', 0.05); // Success sound
      target.fly=true; target.done=true; wordsLeft = Math.max(0, wordsLeft-1); updateScore();
      score+=1; 
      if(rocket) rocket.grow();
      if(wordsLeft===0 && !gameOver){ rocketLaunched=true; if(rocket) rocket.launch(); }
    } else if(!target.answer.toString().startsWith(target.input)){
      // Wrong digit - play error sound and clear input
      beep(180, 0.15, 'sawtooth', 0.05); // Error sound
      target.input='';
    }
  }
});

/* ===== sliders and level selection ===== */
speedSlider.addEventListener('input',()=>{ speedValue=parseFloat(speedSlider.value)/4; speedVal.textContent=speedSlider.value; });
laneSlider.addEventListener('input',()=>{ 
  lanes=parseInt(laneSlider.value); 
  laneW=W/lanes; 
  laneVal.textContent=lanes; 
  // Ensure player lane is within new lane count
  playerLane = Math.min(playerLane, lanes-1);
  draw(); // Redraw to show updated lane indicator
});

// Level selection event listeners
document.querySelectorAll('input[name="level"]').forEach(radio => {
  radio.addEventListener('change', () => {
    // Regenerate all current problems with new difficulty
    words.forEach(word => {
      if (!word.done && !word.fly) {
        const newProblem = generateMathProblem();
        word.text = newProblem.text;
        word.answer = newProblem.answer;
        word.input = '';
      }
    });
    draw(); // Redraw to show updated problems
  });
});

/* ===== splash ===== */
splashBtn.addEventListener('click',()=>{ splashScreen.style.display='none'; startNextLevel(); });
function splashLevelOver(success){
  splashText.textContent = success? "Level Complete!" : "Game Over!";
  splashScreen.style.display='flex';
}

// Initialize modular components first, then start the game
initModularComponents().then(() => {
  resetLevel();
  draw(); // Draw immediately to show player lane indicator
  step();
}).catch(error => {
  console.error('Failed to initialize game:', error);
  // Fallback to basic game without modular components
  resetLevel();
  draw();
  step();
});
})();
</script>

</body>
</html>
