<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Word Defenders</title>
<style>
:root {
  --green: #0f0;
  --yellow: #ff0;
  --red: #f00;
  --bg: #000;
}
html, body { height: 100%; margin:0; padding:0; background: var(--bg); font-family: monospace; color: var(--green); overflow:hidden; }
#container { display: flex; justify-content: center; align-items: flex-start; gap: 20px; padding:20px; position:relative; }
#gameNav, 
#gameNav a {
  display: block;
  margin-top: 5px;
  text-transform: uppercase;
  color: #0f0;
  text-decoration: none;
}

#gameNav a.active {
  color: #ff0;       /* highlight color */
  font-weight: bold;  /* optional emphasis */
  text-decoration: underline;
}
#game { border: 4px solid var(--green); width: 540px; height: 640px; background: var(--bg); image-rendering: pixelated; display: block; position:relative; z-index:1; }
#sidebar { width:450px; display:flex; flex-direction:column; gap:10px; }
#title { text-transform: uppercase; font-size: 2rem; color: #ff0; text-shadow: 0 0 8px #f00; text-align: center; }
#scoreboard { border: 2px solid var(--green); padding:8px; font-size:0.9rem; }
.section-title { color: var(--yellow); font-weight:bold; margin-bottom:4px; }
#controls { font-size:0.9rem; }
.pill { border:1px solid var(--green); padding:6px 8px; display:inline-block; cursor:pointer; margin-right:4px; user-select:none; }
.toggle input { accent-color: var(--green); }
#wordList { width:100%; height:80px; background:#001100; color: var(--green); border:1px solid var(--green); padding:6px; font-family:monospace; }
input[type=range] { width:100%; }
#quotes { margin-top:8px; font-size:0.9rem; height:24px; text-align:center; }

/* Full-screen rocket/fireworks overlay on top of everything */
#rocketOverlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }

/* Splash screen */
#splashScreen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); color:#fff; font-size:2rem; display:none; justify-content:center; align-items:center; flex-direction:column; text-align:center; z-index:1000; }
#splashScreen button { margin-top:20px; padding:10px 20px; font-size:1rem; cursor:pointer; }
</style>
</head>
<body>
<div id="splashScreen"><div id="splashText">Level Complete!</div><button id="splashBtn">Next Level</button></div>
<div id="container">
  <nav id="gameNav" style="padding:10px; background:#111; color:#0f0; font-family:monospace;">
    <strong>Games:</strong>
  </nav>
    <script src="navigation.js"></script>
  <canvas id="game" width="540" height="640"></canvas>
  <div id="sidebar">
    <div id="title">WORD DEFENDERS</div>
    <div id="scoreboard">
      <div class="section-title">SCORE</div>
      <div>Score: <span id="score">0</span> | Words Left: <span id="wordsLeft">0</span> | WPM: <span id="wpm">0</span></div>
      <div>Timer: <span id="timerDisplay">0:00</span></div>
    </div>
    <div id="controls">
      <div class="section-title">CONTROLS</div>
      1 / ←: Move Left<br>
      2 / →: Move Right<br>
      Type letters: Shoot word in lane<br>
      Space: Start / Pause<br>
      0: Reset
    </div>
    <div style="display:flex; gap:10px;">
      <div>
        <div class="section-title">SPEED</div>
        <input type="range" id="speedSlider" min="1" max="10" step="1" value="2">
        <div id="speedVal">2</div>
      </div>
      <div>
        <div class="section-title">LANES</div>
        <input type="range" id="laneSlider" min="1" max="8" step="1" value="4">
        <div id="laneVal">4</div>
      </div>
    </div>
    <div>
      <div class="section-title">WORD LIST</div>
      <select id="wordListSelect"></select>
      <textarea id="wordList"></textarea><br>
      <button class="pill" id="applyWords">Apply</button>
      <button class="pill" id="resetWords">Default</button>
    </div>
    <div>
      <div class="section-title">TIMER</div>
      <label class="pill"><input type="checkbox" id="timerToggle"> Timer Mode</label>
      <input type="range" id="timerSlider" min="1" max="5" step="1" value="3">
      <div id="timerVal">3 min</div>
    </div>
    <div id="quotes"></div>
  </div>
  <canvas id="rocketOverlay" width="1200" height="720"></canvas>
</div>
<script type="module">
import { GameAudio } from './audio.js';
import { Fireworks } from './fireworks.js';
import { Rocket } from './rocket.js';

(() => {
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;
let lanes = 4, playerLane = 0; // Start in leftmost lane
let laneW = W/lanes, floorY = H-48;

let score=0, lives=3, running=true, gameOver=false;
let speedValue=parseFloat(document.getElementById('speedSlider').value)/4;
let words=[], wordsLeft=0, totalWordsInLevel=20, spawnedCount=0;
let rocketLaunched=false, lastOutcomeSuccess=false;
let startTime, timerDuration=180;
let level=1;

const speedSlider=document.getElementById('speedSlider');
const laneSlider=document.getElementById('laneSlider');
const speedVal=document.getElementById('speedVal');
const laneVal=document.getElementById('laneVal');
const scoreEl=document.getElementById('score');
const wordsLeftEl=document.getElementById('wordsLeft');
const wpmEl=document.getElementById('wpm');
const wordListSelect=document.getElementById('wordListSelect');
const applyWordsBtn=document.getElementById('applyWords');
const resetWordsBtn=document.getElementById('resetWords');
const timerToggle=document.getElementById('timerToggle');
const timerSlider=document.getElementById('timerSlider');
const timerVal=document.getElementById('timerVal');
const timerDisplay=document.getElementById('timerDisplay');
const quotesEl=document.getElementById('quotes');
const splashScreen=document.getElementById('splashScreen');
const splashBtn=document.getElementById('splashBtn');
const splashText=document.getElementById('splashText');

const audio = new GameAudio();
const rocketOverlay=document.getElementById('rocketOverlay');
function beep(freq=440,dur=0.07,type='square',vol=0.02){
  audio.beep(freq, dur, type, vol);
}
function rocketRumble(){
  audio.rocketRumble();
}
function fireworksPop(){
  audio.fireworksPop();
}

/* ===== word lists ===== */
const wordListsData=[
  {name:"Beginner 0 (2 letter)", words:["an", "as", "at", "in", "is", "it" ]},
  {name:"Beginner 1 (3 letter)", words:["ant", "nan", "nap", "nip", "nit", "pan", "pat", "pin", "pip", "pit", "sat", "sip", "sit", "tan", "tap", "tin", "tip" ]},
  {name:"Easy 2", words:["fish","frog","tree","milk","bird"]},
  {name:"Medium 3", words:["apple","chair","train","horse","glass"]},
  {name:"Hard 4", words:["banana","school","friend","planet","happy"]},
  {name:"Expert 5", words:["elephant","computer","kangaroo","mountain","diamond"]}
];
wordListsData.forEach((wl,i)=>{
  let opt=document.createElement('option');
  opt.value=i; opt.textContent=wl.name;
  wordListSelect.appendChild(opt);
});
let wordBank = [...wordListsData[0].words];
applyWordsBtn.onclick = ()=>{ wordBank=[...wordListsData[parseInt(wordListSelect.value)].words]; resetLevel(true); };
resetWordsBtn.onclick = ()=>{ wordBank=[...wordListsData[0].words]; resetLevel(true); };

/* ===== quotes ===== */
const QUOTES=["You are brave and strong!","Trust yourself—you can do it!","Your kindness makes magic!","Every step shows courage!","You are unstoppable!","Believe in yourself!","Your heart is full of power!","You are wise and brave!","Shine with your own light!","You make the world brighter!"];
let quoteIndex=0;
function rotateQuotes(){ quotesEl.textContent=QUOTES[quoteIndex]; quoteIndex=(quoteIndex+1)%QUOTES.length; }
setInterval(rotateQuotes,5000); rotateQuotes();

/* ===== words & lanes ===== */
function laneX(l){ return l*laneW+laneW/2; }
function randWord(){ return wordBank[Math.floor(Math.random()*wordBank.length)]; }
// randColor function moved to fireworks.js module

/* Random spawn timing */
let nextSpawnAt=0;
function scheduleNextSpawn(){
  nextSpawnAt = Date.now() + 350 + Math.random()*1100;
}
function spawnWord(){
  if(wordsLeft<=0 || spawnedCount>=totalWordsInLevel) return;
  if(Date.now() < nextSpawnAt) return;
  const l = Math.floor(Math.random()*lanes);
  const crowded=words.some(w=>w.lane===l && w.y<80 && !w.fly);
  if(!crowded){
    const text=randWord();
    words.push({text,lane:l,y:-10,progress:0,done:false,speed:speedValue,color:fireworks.randColor(),fly:false,alpha:1});
    spawnedCount++;
  }
  scheduleNextSpawn();
}

/* ===== Rocket Class (overlay, visuals, audio, movement) ===== */
// Rocket class is now imported from rocket.js module

/* ===== level control ===== */
let rocket; // single instance
let fireworks; // fireworks instance for color generation
function resetLevel(keepLevelNumber=false){
  if(!keepLevelNumber) level=1;
  score=0; lives=3; running=true; gameOver=false; words=[]; rocketLaunched=false; lastOutcomeSuccess=false;
  lanes=parseInt(laneSlider.value); laneW=W/lanes;
  speedValue=parseFloat(speedSlider.value)/4; 
  totalWordsInLevel = wordBank.length*4;
  spawnedCount=0;
  wordsLeft=totalWordsInLevel;
  startTime = Date.now();
  timerDuration=parseInt(timerSlider.value)*60*1000;
  updateScore();
  scheduleNextSpawn();
  draw();

  // (Re)create rocket if needed, else reset it
  if(!rocket){
    fireworks = new Fireworks(rocketOverlay, audio);
    rocket = new Rocket(
      rocketOverlay,
      audio,
      fireworks,
      () => { splashLevelOver(true); } // after fireworks
    );
  } else {
    rocket.resetForLevel();
  }
}
function startNextLevel(){
  level++;
  running=true; gameOver=false; words=[]; rocketLaunched=false; lastOutcomeSuccess=false;
  spawnedCount=0;
  wordsLeft=totalWordsInLevel;
  startTime=Date.now();
  scheduleNextSpawn();
  rocket && rocket.resetForLevel();
}

/* ===== scoreboard ===== */
function updateScore(){
  scoreEl.textContent=score;
  wordsLeft = Math.max(0, wordsLeft);
  wordsLeftEl.textContent=wordsLeft;
}

/* ===== draw ===== */
function drawWord(w){
  const x=laneX(w.lane), y=w.y;
  ctx.font='28px monospace'; ctx.textAlign='center';
  let typed=w.text.slice(0,w.progress),rest=w.text.slice(w.progress);
  if(w.fly){
    w.y-=6; w.alpha-=0.07;
    ctx.fillStyle=`rgba(255,255,255,${w.alpha})`; ctx.fillText(w.text,x,y);
    if(w.alpha<=0) w.done=true; return;
  }
  if(w.done && !w.fly){
    ctx.fillStyle="#f00"; ctx.save(); ctx.translate(x,y); ctx.rotate(Math.PI); ctx.fillText(w.text,0,0); ctx.restore(); return;
  }
  ctx.fillStyle='#fff'; ctx.fillText(typed,x-ctx.measureText(rest).width/2,y);
  ctx.fillStyle=w.color; ctx.fillText(rest,x+ctx.measureText(typed).width/2,y);
}
function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#0f0"; ctx.lineWidth=1;
  for(let l=1;l<lanes;l++){ ctx.beginPath(); ctx.moveTo(l*laneW+0.5,0); ctx.lineTo(l*laneW+0.5,H); ctx.stroke(); }
  ctx.beginPath(); ctx.moveTo(0,floorY+12); ctx.lineTo(W,floorY+12); ctx.stroke();
  for(const w of words) drawWord(w);
  ctx.fillStyle="#0f0"; ctx.font='16px monospace'; ctx.textAlign='left'; ctx.fillText(`LIVES: ${lives}`,8,16);
  ctx.textAlign='center';
  ctx.fillStyle="#ff0"; ctx.fillRect(laneX(playerLane)-15,floorY-12,30,12);
  ctx.fillStyle="#0f0"; ctx.textAlign='right'; ctx.fillText(running?'RUN':'PAUSE',W-8,16);
}

/* ===== game step ===== */
function step(){
  if(!running){ draw(); requestAnimationFrame(step); return; }

  if(timerToggle.checked){
    const elapsed=Date.now()-startTime, remaining=Math.max(0,timerDuration-elapsed);
    timerDisplay.textContent=Math.floor(remaining/60000)+":"+("0"+Math.floor((remaining%60000)/1000)).slice(-2);
    if(remaining<=0){ gameOver=true; running=false; lastOutcomeSuccess=false; splashLevelOver(false); return; }
  }

  spawnWord();

  for(const w of words){ if(!w.done && !w.fly) w.y+=speedValue; }

  // Missed words that reach bottom
  for(const w of words){
    if(!w.done && !w.fly && w.y>=floorY){
      lives--; w.done=true; wordsLeft = Math.max(0, wordsLeft-1);
      beep(140,0.08);
      if(lives<=0){ gameOver=true; running=false; lastOutcomeSuccess=false; splashLevelOver(false); }
    }
  }

  // Level completion
if(!gameOver){
  if(wordsLeft===0){
    running=false;
    lastOutcomeSuccess = (lives>0);
    if(lastOutcomeSuccess && !rocketLaunched){
      rocketLaunched = true;
      rocket && rocket.launch(); // splash will be triggered by rocket's onFireworksDone
    } else if(!lastOutcomeSuccess){
      splashLevelOver(false); // only immediate game over
    }
  }
}

  updateScore();
  draw();
  requestAnimationFrame(step);
}

/* ===== typing ===== */
function wordInPlayerLane(){
  const candidates = words.filter(w=>!w.done && !w.fly && w.lane===playerLane);
  candidates.sort((a,b)=>b.y-a.y);
  return candidates[0]||null;
}
document.addEventListener('keydown',(e)=>{
  if(e.key==='1'||e.key==='ArrowLeft'){ playerLane=Math.max(0,playerLane-1); beep(300,0.02); return; }
  if(e.key==='2'||e.key==='ArrowRight'){ playerLane=Math.min(lanes-1,playerLane+1); beep(300,0.02); return; }
        if(e.code==='Space'){ running=!running; if(running) audio.resume(); return; }
  if(e.key==='0'){ splashScreen.style.display="none"; resetLevel(false); return; }
  if(e.key.length===1 && /[a-z]/i.test(e.key)){
    const target = wordInPlayerLane();
    if(!target){ beep(180,0.03); return; }
    const expected = target.text[target.progress] || '';
    if(e.key.toLowerCase()===expected){
      target.progress++; beep(520,0.03);
      if(target.progress>=target.text.length){
        target.fly=true; target.done=true; wordsLeft = Math.max(0, wordsLeft-1);
        score+=target.text.length;
        updateScore();

        // GROW ROCKET on each completed word
        rocket && rocket.grow();

        // If last word just finished, trigger rocket launch only
        if(wordsLeft===0 && !gameOver){
          running=false;
          lastOutcomeSuccess = (lives>0);
          if(lastOutcomeSuccess && !rocketLaunched){
            rocketLaunched = true;
            rocket && rocket.launch(); // splash will be triggered by rocket's onFireworksDone
          } else if(!lastOutcomeSuccess){
            splashLevelOver(false); // only immediate game over
          }
        }
      }
    }else{ beep(180,0.03); }
  }
});

/* ===== splash ===== */
function splashLevelOver(success){
  splashText.textContent = success ? `LEVEL ${level} COMPLETE!` : "GAME OVER! Try Again";
  splashScreen.style.display="flex";
}
splashBtn.onclick = ()=>{
  splashScreen.style.display="none";
  if(lastOutcomeSuccess){
    startNextLevel();
  }else{
    resetLevel(false);
  }
  running=true; gameOver=false; rocketLaunched=false;
};

/* ===== UI Events ===== */
speedSlider.oninput=()=>{ speedValue=parseFloat(speedSlider.value)/4; speedVal.textContent=speedSlider.value; };
laneSlider.oninput=()=>{ 
  lanes=parseInt(laneSlider.value); 
  laneW=W/lanes; 
  laneVal.textContent=lanes; 
  // Ensure player lane is within new lane count
  playerLane = Math.min(playerLane, lanes-1);
  draw(); // Redraw to show updated lane indicator
};
timerSlider.oninput=()=>{ timerDuration=parseInt(timerSlider.value)*60*1000; timerVal.textContent=timerSlider.value+" min"; };

/* ===== init ===== */
resetLevel(false);
draw(); // Draw immediately to show player lane indicator
step();
})();
</script>
</body>
</html>
