<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Number Defenders</title>
<style>
:root { 
  --green:#0f0; 
  --yellow:#ff0; 
  --red:#f00; 
  --bg:#000;
  --focus-outline: #0ff;
}

/* Accessibility and mobile improvements */
* {
  box-sizing: border-box;
}

html, body { 
  height:100%; 
  margin:0; 
  padding:0; 
  background: var(--bg); 
  font-family: monospace; 
  color: var(--green); 
  overflow-x: hidden;
  font-size: 16px; /* Prevent zoom on mobile */
}

/* Focus styles for accessibility */
*:focus {
  outline: 2px solid var(--focus-outline);
  outline-offset: 2px;
}

/* Mobile-first responsive design */
#container { 
  display:flex; 
  flex-direction: column;
  justify-content:center; 
  align-items:center; 
  gap:15px; 
  padding:15px; 
  position:relative;
  min-height: 100vh;
}

#gameNav, 
#gameNav a {
  display: block;
  margin-top: 5px;
  text-transform: uppercase;
  color: #0f0;
  text-decoration: none;
  padding: 8px;
  border-radius: 4px;
  transition: background-color 0.2s;
}

#gameNav a:hover,
#gameNav a:focus {
  background-color: rgba(0, 255, 0, 0.1);
}

#gameNav a.active {
  color: #ff0;
  font-weight: bold;
  text-decoration: underline;
  background-color: rgba(255, 255, 0, 0.1);
}

#game { 
  border:4px solid var(--green); 
  width: 100%;
  max-width: 540px;
  height: auto;
  aspect-ratio: 540/640;
  background: var(--bg); 
  image-rendering: pixelated; 
  display:block; 
  position:relative; 
  z-index:1;
}

#sidebar { 
  width: 100%;
  max-width: 450px;
  display:flex; 
  flex-direction:column; 
  gap:15px;
}

#title { 
  text-transform: uppercase; 
  font-size: clamp(1.5rem, 4vw, 2rem);
  color: #ff0; 
  text-shadow: 0 0 8px #f00; 
  text-align: center;
  margin: 0;
}

#scoreboard { 
  border:2px solid var(--green); 
  padding:12px; 
  font-size:0.9rem;
  border-radius: 6px;
}

.section-title { 
  color: var(--yellow); 
  font-weight:bold; 
  margin-bottom:8px;
}

#controls { 
  font-size:0.9rem;
  line-height: 1.4;
}

.pill { 
  border:1px solid var(--green); 
  padding:8px 12px; 
  display:inline-block; 
  cursor:pointer; 
  margin:4px 4px 4px 0; 
  user-select:none;
  border-radius: 4px;
  transition: background-color 0.2s;
  background: transparent;
}

.pill:hover,
.pill:focus {
  background-color: rgba(0, 255, 0, 0.1);
}

.toggle input { 
  accent-color: var(--green);
  margin-right: 8px;
}

input[type=range] { 
  width:100%;
  margin: 8px 0;
}

#quotes { 
  margin-top:12px; 
  font-size:0.9rem; 
  min-height:24px; 
  text-align:center;
  font-style: italic;
}

#rocketOverlay { 
  position:absolute; 
  top:0; 
  left:0; 
  width:100%; 
  height:100%; 
  pointer-events:none; 
  z-index:999; 
}

#splashScreen { 
  position:absolute; 
  top:0; 
  left:0; 
  width:100%; 
  height:100%; 
  background:rgba(0,0,0,0.9); 
  color:#fff; 
  font-size: clamp(1.5rem, 5vw, 2rem);
  display:none; 
  justify-content:center; 
  align-items:center; 
  flex-direction:column; 
  text-align:center; 
  z-index:1000;
  padding: 20px;
}

#splashScreen button { 
  margin-top:20px; 
  padding:12px 24px; 
  font-size:1rem; 
  cursor:pointer;
  background: var(--green);
  color: var(--bg);
  border: none;
  border-radius: 6px;
  font-family: monospace;
  transition: background-color 0.2s;
}

#splashScreen button:hover,
#splashScreen button:focus {
  background: #0a0;
}

.mode-settings { 
  margin-top:12px; 
  font-size:0.9rem;
  line-height: 1.4;
}

/* Directional controls */
.directional-controls {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin: 15px 0;
}

.dir-row {
  display: flex;
  gap: 20px;
}

.dir-btn {
  background: rgba(0, 255, 0, 0.2);
  border: 2px solid var(--green);
  color: var(--green);
  padding: 20px;
  border-radius: 50%;
  font-size: 1.5rem;
  font-family: monospace;
  cursor: pointer;
  user-select: none;
  touch-action: manipulation;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.dir-btn:hover,
.dir-btn:focus,
.dir-btn:active {
  background: rgba(0, 255, 0, 0.4);
  transform: scale(1.1);
}

/* Mobile controls */
.mobile-controls {
  display: none;
  gap: 10px;
  margin-top: 15px;
  justify-content: center;
}

.mobile-btn {
  background: rgba(0, 255, 0, 0.2);
  border: 2px solid var(--green);
  color: var(--green);
  padding: 15px;
  border-radius: 8px;
  font-size: 1.2rem;
  font-family: monospace;
  cursor: pointer;
  user-select: none;
  touch-action: manipulation;
  min-width: 60px;
  transition: all 0.2s;
}

.mobile-btn:hover,
.mobile-btn:focus,
.mobile-btn:active {
  background: rgba(0, 255, 0, 0.3);
  transform: scale(1.05);
}

/* Mobile input area */
.mobile-input-area {
  display: none;
  margin-top: 15px;
  padding: 15px;
  border: 2px solid var(--green);
  border-radius: 8px;
  background: rgba(0, 255, 0, 0.05);
}

.mobile-input-area .section-title {
  margin-bottom: 15px;
  text-align: center;
}

/* Mobile keypad */
.mobile-keypad {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 15px;
}

.keypad-row {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.keypad-key {
  background: rgba(0, 255, 0, 0.1);
  border: 2px solid var(--green);
  color: var(--green);
  padding: 15px 12px;
  border-radius: 8px;
  font-family: monospace;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  user-select: none;
  touch-action: manipulation;
  min-width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.keypad-key:hover,
.keypad-key:focus,
.keypad-key:active {
  background: rgba(0, 255, 0, 0.3);
  transform: scale(1.05);
}

.keypad-key[data-key="backspace"] {
  background: rgba(255, 0, 0, 0.2);
  border-color: var(--red);
  color: var(--red);
  min-width: 60px;
}

.keypad-key[data-key="enter"] {
  background: rgba(0, 255, 0, 0.3);
  border-color: var(--green);
  color: var(--green);
  min-width: 60px;
}

.keypad-key[data-key="backspace"]:hover,
.keypad-key[data-key="backspace"]:focus,
.keypad-key[data-key="backspace"]:active {
  background: rgba(255, 0, 0, 0.4);
}

.keypad-key[data-key="enter"]:hover,
.keypad-key[data-key="enter"]:focus,
.keypad-key[data-key="enter"]:active {
  background: rgba(0, 255, 0, 0.5);
}

.input-help {
  font-size: 0.9rem;
  color: var(--yellow);
  text-align: center;
  font-style: italic;
}

/* Responsive breakpoints */
@media (min-width: 768px) {
  #container {
    flex-direction: row;
    align-items: flex-start;
    gap: 20px;
    padding: 20px;
  }
  
  #game {
    width: 540px;
    height: 640px;
  }
  
  #sidebar {
    width: 450px;
  }
  
  .mobile-controls {
    display: none;
  }
}

@media (max-width: 767px) {
  .mobile-controls {
    display: flex;
  }
  
  .directional-controls {
    display: flex;
  }
  
  .mobile-input-area {
    display: block;
  }
  
  #container {
    padding: 10px;
  }
  
  #game {
    max-width: 100vw;
    margin: 0 auto;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --green: #00ff00;
    --yellow: #ffff00;
    --red: #ff0000;
    --focus-outline: #ffffff;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Skip link for accessibility */
.skip-link {
  position: absolute;
  top: -40px;
  left: 6px;
  background: var(--green);
  color: var(--bg);
  padding: 8px;
  text-decoration: none;
  border-radius: 4px;
  z-index: 1001;
  transition: top 0.3s;
}

.skip-link:focus {
  top: 6px;
}

/* Screen reader support */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
</style>
</head>
<body>
<!-- Skip to main content link for accessibility -->
<a href="#game" class="skip-link">Skip to game</a>

<div id="splashScreen" role="dialog" aria-labelledby="splashText" aria-describedby="splashBtn">
  <div id="splashText" role="heading" aria-level="2">Level Complete!</div>
  <button id="splashBtn">Next Level</button>
</div>
<div id="container">  
   <nav id="gameNav" style="padding:10px; background:#111; color:#0f0; font-family:monospace;">
    <strong>Games:</strong>
  </nav>
  <script src="navigation.js"></script>
  <canvas id="game" width="540" height="640" role="img" aria-label="Number Defenders game area" tabindex="0"></canvas>
  
  <!-- Directional Controls (Mobile) -->
  <div class="directional-controls">
    <button class="dir-btn" id="dirUpBtn" aria-label="Move Up">‚Üë</button>
    <div class="dir-row">
      <button class="dir-btn" id="dirLeftBtn" aria-label="Move Left">‚Üê</button>
      <button class="keypad-key" id="dirRightBtn" aria-label="Move Right">‚Üí</button>
    </div>
  </div>
  
  <!-- Mobile Input Area - Directly below game -->
  <div class="mobile-input-area">
    <div class="section-title">SOLVE PROBLEMS</div>
    <div class="mobile-keypad">
      <div class="keypad-row">
        <button class="keypad-key" data-key="1">1</button>
        <button class="keypad-key" data-key="2">2</button>
        <button class="keypad-key" data-key="3">3</button>
      </div>
      <div class="keypad-row">
        <button class="keypad-key" data-key="4">4</button>
        <button class="keypad-key" data-key="5">5</button>
        <button class="keypad-key" data-key="6">6</button>
      </div>
      <div class="keypad-row">
        <button class="keypad-key" data-key="7">7</button>
        <button class="keypad-key" data-key="8">8</button>
        <button class="keypad-key" data-key="9">9</button>
      </div>
      <div class="keypad-row">
        <button class="keypad-key" data-key="0">0</button>
        <button class="keypad-key" data-key="backspace">‚å´</button>
        <button class="keypad-key" data-key="enter">‚Üµ</button>
      </div>
    </div>
    <div class="input-help">Tap numbers to solve math problems in your lane</div>
  </div>
  
  <div id="sidebar">
      <h1 id="title">NUMBER DEFENDERS</h1>
  <div id="scoreboard" role="region" aria-label="Game Score">
      <div class="section-title">SCORE</div>
    <div>Score: <span id="score" aria-live="polite">0</span> | Problems Left: <span id="wordsLeft" aria-live="polite">0</span></div>
    <div>Timer: <span id="timerDisplay" aria-live="polite">0:00</span></div>
    </div>
  <div id="controls" role="region" aria-label="Game Controls">
      <div class="section-title">CONTROLS</div>
    <div role="list">
      <div role="listitem">‚Üê: Move Left</div>
      <div role="listitem">‚Üí: Move Right</div>
      <div role="listitem">Type numbers: Solve problem in lane</div>
      <div role="listitem">Space: Start / Pause</div>
      <div role="listitem">R: Reset Level</div>
    </div>
    </div>

    <div style="display:flex; gap:10px;">
      <div>
        <label for="speedSlider" class="section-title">SPEED</label>
        <input type="range" id="speedSlider" min="1" max="10" step="1" value="2" aria-describedby="speedVal">
        <div id="speedVal" aria-live="polite">2</div>
      </div>
      <div>
        <label for="laneSlider" class="section-title">LANES</label>
        <input type="range" id="laneSlider" min="1" max="8" step="1" value="4" aria-describedby="laneVal">
        <div id="laneVal" aria-live="polite">4</div>
      </div>
      <div>
        <label for="timerSlider" class="section-title">TIMER</label>
        <input type="range" id="timerSlider" min="1" max="10" step="1" value="3" aria-describedby="timerVal">
        <div id="timerVal" aria-live="polite">3</div>
        <label><input type="checkbox" id="timerToggle"> Enable Timer</label>
      </div>
    </div>

    <div class="mode-settings" role="group" aria-labelledby="modeTitle">
      <div id="modeTitle" class="section-title">MODE</div>
      <fieldset>
        <legend class="sr-only">Operation Mode</legend>
      <label><input type="radio" name="mode" value="both" checked> + / - </label>
      <label><input type="radio" name="mode" value="+"> Addition </label>
        <label><input type="radio" name="mode" value="-"> Subtraction </label>
      </fieldset>
      <label><input type="checkbox" id="allowNeg"> Allow negative answers</label>
    </div>

    <div id="quotes" role="status" aria-live="polite"></div>
  
      <!-- Mobile Controls -->
    <div class="mobile-controls">
      <button class="mobile-btn" id="leftBtn" aria-label="Move Left">‚Üê</button>
      <button class="mobile-btn" id="rightBtn" aria-label="Move Right">‚Üí</button>
      <button class="mobile-btn" id="pauseBtn" aria-label="Pause/Resume">‚è∏</button>
      <button class="mobile-btn" id="resetBtn" aria-label="Reset Level">üîÑ</button>
    </div>
    
    <!-- Mobile Input Area -->
    <div class="mobile-input-area">
      <div class="section-title">SOLVE PROBLEMS</div>
      <input type="text" id="mobileNumberInput" placeholder="Type numbers here..." maxlength="10" />
      <button class="mobile-btn" id="submitNumberBtn" aria-label="Submit Answer">Submit</button>
      <div class="input-help">Type numbers to solve math problems in your lane</div>
    </div>
  </div>
  <canvas id="rocketOverlay" width="1200" height="720"></canvas>
</div>
<script type="module">
import { GameAudio } from './audio.js';
import { Fireworks } from './fireworks.js';
import { Rocket } from './rocket.js';

(() => {
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;
let lanes = 4, playerLane = 0; // Start in leftmost lane
let laneW = W/lanes, floorY = H-48;

let score=0, lives=3, running=true, gameOver=false;
let speedValue=parseFloat(document.getElementById('speedSlider').value)/4;
let words=[], wordsLeft=0, totalWordsInLevel=20, spawnedCount=0;
let rocketLaunched=false, lastOutcomeSuccess=false;
let startTime, timerDuration=180;
let level=1, maxOperand=20;

const speedSlider=document.getElementById('speedSlider');
const laneSlider=document.getElementById('laneSlider');
const speedVal=document.getElementById('speedVal');
const laneVal=document.getElementById('laneVal');
const scoreEl=document.getElementById('score');
const wordsLeftEl=document.getElementById('wordsLeft');
const timerToggle=document.getElementById('timerToggle');
const timerSlider=document.getElementById('timerSlider');
const timerVal=document.getElementById('timerVal');
const timerDisplay=document.getElementById('timerDisplay');
const quotesEl=document.getElementById('quotes');
const splashScreen=document.getElementById('splashScreen');
const splashBtn=document.getElementById('splashBtn');
const splashText=document.getElementById('splashText');

const audio = new GameAudio();
const rocketOverlay=document.getElementById('rocketOverlay');
function beep(freq=440,dur=0.07,type='square',vol=0.02){
  audio.beep(freq, dur, type, vol);
}
function rocketRumble(){
  audio.rocketRumble();
}
function fireworksPop(){
  audio.fireworksPop();
}

/* ===== quotes ===== */
const QUOTES=["You are brave and strong!","Trust yourself‚Äîyou can do it!","Every step shows courage!","You are unstoppable!"];
let quoteIndex=0;
function rotateQuotes(){ quotesEl.textContent=QUOTES[quoteIndex]; quoteIndex=(quoteIndex+1)%QUOTES.length; }
setInterval(rotateQuotes,5000); rotateQuotes();

/* ===== words & lanes ===== */
function laneX(l){ return l*laneW+laneW/2; }
// randColor function moved to fireworks.js module

/* ===== Math problem generator ===== */
function generateMathProblem(){
  let a = Math.floor(Math.random()*maxOperand);
  let b = Math.floor(Math.random()*maxOperand);
  let op = document.querySelector('input[name="mode"]:checked').value;
  if(op==='both'){ op = Math.random()<0.5 ? '+' : '-'; }
  if(!document.getElementById('allowNeg').checked && op==='-' && b>a){
    [a,b]=[b,a];
  }
  const text = `${a}${op}${b}`;
  const answer = op==='+' ? a+b : a-b;
  return { text, answer };
}

/* Random spawn timing */
let nextSpawnAt=0;
function scheduleNextSpawn(){ nextSpawnAt = Date.now() + 350 + Math.random()*1100; }
function spawnWord(){
  if(wordsLeft<=0 || spawnedCount>=totalWordsInLevel) return;
  if(Date.now() < nextSpawnAt) return;
  const l = Math.floor(Math.random()*lanes);
  const crowded=words.some(w=>w.lane===l && w.y<80 && !w.fly);
  if(!crowded){
    const problem = generateMathProblem();
    words.push({ text: problem.text, answer: problem.answer, lane:l, y:-10, progress:0, input:'', done:false, fly:false, alpha:1, color: fireworks.randColor() });
    spawnedCount++;
  }
  scheduleNextSpawn();
}

/* ===== Rocket Class ===== */
// Rocket class is now imported from rocket.js module

/* ===== Level Reset ===== */
let rocket;
let fireworks; // fireworks instance for color generation
function resetLevel(keepLevelNumber=false){
  if(!keepLevelNumber) level=1;
  score=0; lives=3; running=true; gameOver=false; words=[]; rocketLaunched=false; lastOutcomeSuccess=false;
  lanes=parseInt(laneSlider.value); laneW=W/lanes;
  speedValue=parseFloat(speedSlider.value)/4;
  totalWordsInLevel = 20;
  spawnedCount=0;
  wordsLeft=totalWordsInLevel;
  startTime = Date.now();
  timerDuration=parseInt(timerSlider.value)*60*1000;
  maxOperand = level<=2 ? 10 : 20;
  updateScore();
  scheduleNextSpawn();
  draw();
  if(!rocket){
    fireworks = new Fireworks(rocketOverlay, audio);
    rocket = new Rocket(
      rocketOverlay,
      audio,
      fireworks,
      ()=>{ splashLevelOver(true); level++; }
    );
  } else { rocket.resetForLevel(); }
}
function startNextLevel(){ resetLevel(true); }

/* ===== scoreboard ===== */
function updateScore(){ scoreEl.textContent=score; wordsLeftEl.textContent=wordsLeft; }

/* ===== draw ===== */
function drawWord(w){
  const x=laneX(w.lane), y=w.y;
  ctx.font='28px monospace'; ctx.textAlign='center';
  ctx.fillStyle=w.color;
  let displayText = w.text + (w.input ? ` (${w.input})` : '');
  if(w.fly){ w.y-=6; w.alpha-=0.07; ctx.fillStyle=`rgba(255,255,255,${w.alpha})`; ctx.fillText(displayText,x,y); if(w.alpha<=0) w.done=true; return; }
  if(w.done && !w.fly){ ctx.fillStyle="#f00"; ctx.save(); ctx.translate(x,y); ctx.rotate(Math.PI); ctx.fillText(displayText,0,0); ctx.restore(); return; }
  ctx.fillText(displayText,x,y);
}
function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#0f0"; ctx.lineWidth=1;
  for(let l=1;l<lanes;l++){ ctx.beginPath(); ctx.moveTo(l*laneW+0.5,0); ctx.lineTo(l*laneW+0.5,H); ctx.stroke(); }
  ctx.beginPath(); ctx.moveTo(0,floorY+12); ctx.lineTo(W,floorY+12); ctx.stroke();
  for(const w of words) drawWord(w);
  ctx.fillStyle="#0f0"; ctx.font='16px monospace'; ctx.textAlign='left'; ctx.fillText(`LIVES: ${lives}`,8,16);
  ctx.textAlign='center'; ctx.fillStyle='#ff0'; ctx.fillRect(laneX(playerLane)-15,floorY-12,30,12);
  ctx.fillStyle='#0f0'; ctx.textAlign='right'; ctx.fillText(running?'RUN':'PAUSE',W-8,16);
}

/* ===== game step ===== */
function step(){
  if(!running){ draw(); requestAnimationFrame(step); return; }
  if(timerToggle && timerToggle.checked){
    const elapsed=Date.now()-startTime, remaining=Math.max(0,timerDuration-elapsed);
    timerDisplay.textContent=Math.floor(remaining/60000)+":"+("0"+Math.floor((remaining%60000)/1000)).slice(-2);
    if(remaining<=0){ gameOver=true; running=false; lastOutcomeSuccess=false; splashLevelOver(false); return; }
  }
  spawnWord();
  for(const w of words) if(!w.done && !w.fly) w.y+=speedValue;

  for(const w of words){
    if(!w.done && !w.fly && w.y>=floorY){ lives--; w.done=true; wordsLeft = Math.max(0, wordsLeft-1); updateScore(); beep(140,0.08); if(lives<=0){ gameOver=true; running=false; lastOutcomeSuccess=false; splashLevelOver(false); } }
  }

  draw();
  requestAnimationFrame(step);
}

/* ===== keyboard input ===== */
document.addEventListener('keydown',(e)=>{
  if(e.key===' '){ running=!running; return; }
  if(e.key.toLowerCase()==='r'){ resetLevel(true); return; }

  if(e.key==='ArrowLeft'){ playerLane=Math.max(0,playerLane-1); return; }
  if(e.key==='ArrowRight'){ playerLane=Math.min(lanes-1,playerLane+1); return; }

  const target = words.find(w=>!w.done && w.lane===playerLane);
  if(!target) return;
  if(/[0-9\-]/.test(e.key)){
    if(e.key==='-' && target.input.includes('-')) return;
    target.input = (target.input||'') + e.key;
  }

  if(parseInt(target.input) === target.answer){
    target.fly=true; target.done=true; wordsLeft = Math.max(0, wordsLeft-1); updateScore();
    score+=1; rocket && rocket.grow();
    beep(800,0.05); // Success sound when problem is solved
    if(wordsLeft===0 && !gameOver){ rocketLaunched=true; rocket && rocket.launch(); }
  } else if(!target.answer.toString().startsWith(target.input)){ beep(180,0.03); target.input=''; }
});

/* ===== sliders ===== */
speedSlider.addEventListener('input',()=>{ speedValue=parseFloat(speedSlider.value)/4; speedVal.textContent=speedSlider.value; });
laneSlider.addEventListener('input',()=>{ 
  lanes=parseInt(laneSlider.value); 
  laneW=W/lanes; 
  laneVal.textContent=lanes; 
  // Ensure player lane is within new lane count
  playerLane = Math.min(playerLane, lanes-1);
  draw(); // Redraw to show updated lane indicator
});

/* ===== Mobile Controls ===== */
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const dirUpBtn = document.getElementById('dirUpBtn');
const dirLeftBtn = document.getElementById('dirLeftBtn');
const dirRightBtn = document.getElementById('dirRightBtn');

// Mobile keypad functionality
let currentNumberInput = '';
const keypadKeys = document.querySelectorAll('.keypad-key');

// Mobile button handlers
leftBtn.addEventListener('click', () => {
  playerLane = Math.max(0, playerLane - 1);
  draw();
});

rightBtn.addEventListener('click', () => {
  playerLane = Math.min(lanes - 1, playerLane + 1);
  draw();
});

// Directional control handlers
dirLeftBtn.addEventListener('click', () => {
  playerLane = Math.max(0, playerLane - 1);
  draw();
});

dirRightBtn.addEventListener('click', () => {
  playerLane = Math.min(lanes - 1, playerLane + 1);
  draw();
});

dirUpBtn.addEventListener('click', () => {
  // Could be used for special actions or just visual feedback
  beep(400, 0.02);
});

pauseBtn.addEventListener('click', () => {
  running = !running;
  pauseBtn.textContent = running ? '‚è∏' : '‚ñ∂';
  draw();
});

resetBtn.addEventListener('click', () => {
  splashScreen.style.display = 'none';
  resetLevel(true);
  running = true;
  gameOver = false;
  rocketLaunched = false;
  pauseBtn.textContent = '‚è∏';
});

// Mobile keypad functionality
keypadKeys.forEach(key => {
  key.addEventListener('click', () => {
    const keyValue = key.dataset.key;
    
    if (keyValue === 'backspace') {
      // Remove last character
      currentNumberInput = currentNumberInput.slice(0, -1);
    } else if (keyValue === 'enter') {
      // Submit the answer
      if (currentNumberInput) {
        const target = words.find(w => !w.done && !w.fly && w.lane === playerLane);
        if (target) {
          // Check if answer is correct
          if (parseInt(currentNumberInput) === target.answer) {
            target.fly = true;
            target.done = true;
            wordsLeft = Math.max(0, wordsLeft - 1);
            updateScore();
            score += 1;
            rocket && rocket.grow();
            beep(800, 0.05); // Success sound when problem is solved
            if (wordsLeft === 0 && !gameOver) {
              rocketLaunched = true;
              rocket && rocket.launch();
            }
          } else {
            beep(180, 0.03);
          }
        } else {
          beep(180, 0.03);
        }
        currentNumberInput = '';
      }
    } else {
      // Add number to current input
      currentNumberInput += keyValue;
    }
  });
});

// Touch support for mobile
let touchStartX = 0;
let touchStartY = 0;

canvas.addEventListener('touchstart', (e) => {
  e.preventDefault();
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
}, { passive: false });

canvas.addEventListener('touchend', (e) => {
  e.preventDefault();
  const touch = e.changedTouches[0];
  const deltaX = touch.clientX - touchStartX;
  const deltaY = touch.clientY - touchStartY;
  
  // Swipe threshold
  if (Math.abs(deltaX) > 30 || Math.abs(deltaY) > 30) {
    if (Math.abs(deltaX) > Math.abs(deltaY)) {
      // Horizontal swipe
      if (deltaX > 0) {
        playerLane = Math.min(lanes - 1, playerLane + 1);
      } else {
        playerLane = Math.max(0, playerLane - 1);
      }
    } else {
      // Vertical swipe - pause/resume
      running = !running;
      pauseBtn.textContent = running ? '‚è∏' : '‚ñ∂';
    }
    draw();
  }
}, { passive: false });

/* ===== splash ===== */
splashBtn.addEventListener('click',()=>{ splashScreen.style.display='none'; startNextLevel(); });
function splashLevelOver(success){
  splashText.textContent = success? "Level Complete!" : "Game Over!";
  splashScreen.style.display='flex';
}

resetLevel();
draw(); // Draw immediately to show player lane indicator
step();
})();
</script>

</body>
</html>
